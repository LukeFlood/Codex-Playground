<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Wellness Plan Savings Calculator</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
<style>
body { padding: 2rem; }
.select-container { margin-top: 1rem; }
.output { margin-top: 2rem; }
</style>
</head>
<body>
<div class="container">
  <h1 class="title">Veterinary Wellness Plan Savings</h1>

  <div class="field">
    <label class="label" for="plan-select">Select Plan</label>
    <div class="control">
      <div class="select">
        <select id="plan-select">
          <option value="" disabled selected>Select a plan</option>
        </select>
      </div>
    </div>
  </div>

  <div id="plan-details" style="display:none;">
    <div class="columns">
      <div class="column">
        <label class="label">Included Services Used</label>
        <div id="included-container" class="select-container"></div>
      </div>
      <div class="column">
        <label class="label">Optional Services Received</label>
        <div id="optional-container" class="select-container"></div>
      </div>
    </div>

    <div class="field">
      <label class="label" for="additional">Outside of Plan ($)</label>
      <div class="control">
        <input class="input" type="number" id="additional" min="0" step="0.01" value="0">
      </div>
    </div>

    <div class="output">
      <p><strong>Total cost with plan:</strong> $<span id="with-plan">0.00</span></p>
      <p><strong>Total cost without plan:</strong> $<span id="without-plan">0.00</span></p>
      <p><strong>Estimated savings:</strong> $<span id="savings">0.00</span></p>
    </div>
  </div>
</div>

<script>
let plans = [];
let currentPlan = null;
const planSelect = document.getElementById('plan-select');
const includedContainer = document.getElementById('included-container');
const optionalContainer = document.getElementById('optional-container');
const additionalInput = document.getElementById('additional');
const withPlanEl = document.getElementById('with-plan');
const withoutPlanEl = document.getElementById('without-plan');
const savingsEl = document.getElementById('savings');

function formatMoney(value){
  return value.toFixed(2);
}

function populateServices(container, services, cls){
  container.innerHTML = '';
  services.forEach((svc, idx) => {
    if (isNaN(svc.retailPrice) || isNaN(svc.planPrice)) return; // skip invalid entries
    const field = document.createElement('div');
    field.className = 'field is-flex is-justify-content-space-between is-align-items-center mb-1';
    const label = document.createElement('span');
    label.textContent = `${svc.name} ($${svc.retailPrice})`;
    const input = document.createElement('input');
    input.type = 'number';
    input.min = 0;
    input.max = 9;
    input.value = cls === 'included' ? 1 : 0;
    input.addEventListener('focus', e => e.target.select());
    input.dataset.index = idx;
    input.className = `${cls}-qty input`;
    input.style.width = '4rem';
    input.addEventListener('input', calculate);
    field.appendChild(label);
    field.appendChild(input);
    container.appendChild(field);
  });
}


function calculate(){
  if(!currentPlan) return;
  const additional = parseFloat(additionalInput.value) || 0;
  const discountedAdditional = additional * (1 - (currentPlan.percentDiscount || 0));

  const includedInputs = includedContainer.querySelectorAll('.included-qty');
  const optionalInputs = optionalContainer.querySelectorAll('.optional-qty');

  const costWithPlan = currentPlan.annualCost +
    Array.from(optionalInputs).reduce((sum, input) => {
      const qty = parseInt(input.value) || 0;
      const svc = currentPlan.optionalServices[input.dataset.index];
      return sum + qty * (parseFloat(svc.planPrice) || 0);
    }, 0) +
    discountedAdditional;

  const costWithout =
    Array.from(includedInputs).reduce((sum, input) => {
      const qty = parseInt(input.value) || 0;
      const svc = currentPlan.includedServices[input.dataset.index];
      return sum + qty * (parseFloat(svc.retailPrice) || 0);
    }, 0) +
    Array.from(optionalInputs).reduce((sum, input) => {
      const qty = parseInt(input.value) || 0;
      const svc = currentPlan.optionalServices[input.dataset.index];
      return sum + qty * (parseFloat(svc.retailPrice) || 0);
    }, 0) +
    additional;

  withPlanEl.textContent = formatMoney(costWithPlan);
  withoutPlanEl.textContent = formatMoney(costWithout);
  savingsEl.textContent = formatMoney(costWithout - costWithPlan);
}

function onPlanChange(){
  const idx = planSelect.value;
  if(idx === '') return;
  currentPlan = plans[idx];
  document.getElementById('plan-details').style.display = 'block';
  populateServices(includedContainer, currentPlan.includedServices, 'included');
  populateServices(optionalContainer, currentPlan.optionalServices, 'optional');
  additionalInput.value = 0;
  calculate();
}

fetch('data/plans.json')
  .then(res => res.json())
  .then(data => {
    plans = data.plans || [];
    plans.forEach((plan, idx) => {
      const option = document.createElement('option');
      option.value = idx;
      option.textContent = plan.planName;
      planSelect.appendChild(option);
    });
  });

planSelect.addEventListener('change', onPlanChange);
additionalInput.addEventListener('input', calculate);
additionalInput.addEventListener('focus', e => e.target.select());
</script>
</body>
</html>
